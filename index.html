<!DOCTYPE html>
<html ng-app="playerApp">
<head>
    <title></title>
    <link href="styles/bootstrap/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="styles/kendoui/kendo.common.min.css" rel="stylesheet" />
    <link href="styles/kendoui/kendo.silver.min.css" rel="stylesheet" />
    <style>
        .slider{
            margin : 20px;
        }
    </style>
</head>
<body>

    <player></player>

    <script src="libs/jquery/jquery-1.10.2.js"></script>
    <script src="libs/angular/angular.js"></script>
    <script src="libs/bootstrap/bootstrap.min.js"></script>
    <script src="libs/kendoui/kendo.all.min.js"></script>

    <script>
        var playerApp = angular.module('playerApp', []);

        playerApp.factory('playerService', ['$http', function($http){
            return new PlayerService($http);
        }]);

        playerApp.factory('playerModel', ['playerService', function(playerService){
            return new PlayerModel(playerService);
        }]);

        playerApp.controller('playerController', ['$scope', 'playerModel', '$timeout', PlayerController]);
        //playerApp.controller('playerController', ['$scope', PlayerController]);

        function PlayerService($http){

            function query(){
                return null;
            }

            return {
                query: query
            }
        }

        function PlayerDto (id, name, length){
            var _id = id;
            var _name = name;
            var _length = length;

            this.getId = function(){return _id};
            this.getName = function(){return _name};
            this.getLength = function(){return _length};
        }

        function PlayerModel(playerService){
            return {
                data : [
                    new PlayerDto(1, "a.wav", 41),
                    new PlayerDto(2, "b.wav", 2),
                    new PlayerDto(3, "c.mp3", 169)
                ]
            }
        }

        function PlayerController($scope, playerModel, $timeout) {
            $scope.isPlayDisabled = false;
            $scope.isStopDisabled = true;
            $scope.isPauseDisabled = true;
            $scope.position = "00 - 00 / 00";
            $scope.recordings = playerModel.data;
            $scope.filename = "file:" + playerModel.data[0].getName();
            $scope.start = 0;
            $scope.currentPosition = 0;
            $scope.totalLength = 0;
            $scope.timeout = null;
            $scope.qtPlayer = null;
            $scope.isPlaying = false;
            $scope.segmentStart = 0;
            $scope.isBookmarkSet = false;

            $scope.calculateTotalDuration = function(){
                angular.forEach($scope.recordings, function(value, key){
                    $scope.totalLength = $scope.totalLength + value.getLength();
                }, null);
            }

            $scope.calculateTotalDuration();

            $scope.slider = $('#rangeslider').kendoRangeSlider({
                min: 0,
                max: $scope.totalLength,
                smallStep: 1,
                largeStep: 1,
                tickPlacement: "none",
                showButtons: false,
                tooltip : { enabled: false},
                slide: function (e) {
                    $scope.start = e.values[0];
                    $scope.currentPosition = e.values[1];
                    $scope.end = e.values[1];
                    $scope.$apply(function () {
                        $scope.updatePositionLabel();
                    });
                    $scope.isPlayDisabled = false;
                    $scope.isPauseDisabled = true;
                    $scope.stop();
                },
                value: 10
            }).data("kendoRangeSlider");

            if ($scope.start == $scope.currentPosition) {
                $scope.slider.value($scope.start);
            }
            else {
                $scope.slider.values($scope.start,$scope.currentPosition);
            }

            $scope.editor = $('#editor').kendoEditor({
                tools: [
                    "bold",
                    "italic",
                    "strikethrough",
                    "foreColor",
                    "backColor"
                ]
            });

            $scope.play = function (){
                $scope.isPlayDisabled = true;
                $scope.isStopDisabled = false;
                $scope.setPauseButtonState(false);
                $scope.playForward();

                if ($scope.isBookmarkSet){
                    $scope.qtPlayer.SetTime(($scope.start - $scope.segmentStart) * 600);
                } else {
                    if ($scope.segmentStart != $scope.currentPosition) {
                        $scope.qtPlayer.SetTime(($scope.currentPosition - $scope.segmentStart) * 600);
                    }
                }

                $scope.qtPlayer.Play();
                $scope.isPlaying = true;
            }

            $scope.pause = function (){
                $scope.isPlayDisabled = false;
                $scope.isStopDisabled = true;
                $scope.setPauseButtonState(true);
                $timeout.cancel($scope.timeout);
                $scope.isPlaying = false;
                $scope.qtPlayer.Stop();
                $scope.start = $scope.currentPosition;
                if ($scope.currentPosition + 5 > $scope.totalLength) {
                    $scope.end = $scope.totalLength;
                } else {
                    $scope.end = $scope.currentPosition + 5;
                }

                $scope.slider.values($scope.start,$scope.end);
                $scope.isBookmarkSet = true;

                $scope.updatePositionLabel();
            }

            $scope.stop = function (){
                $scope.isPlayDisabled = false;
                $scope.isStopDisabled = true;
                $scope.setPauseButtonState(true);

                $timeout.cancel($scope.timeout);
                $scope.isPlaying = false;
                $scope.currentPosition = $scope.start;

                $scope.qtPlayer.Stop();
                $scope.qtPlayer.Rewind();
            }

            $scope.setPauseButtonState = function (state){
                if ($scope.isBookmarkSet ) {
                    $scope.isPauseDisabled = true;
                } else {
                    $scope.isPauseDisabled = state;
                }
            }

            $scope.playForward = function (){
                if ($scope.currentPosition >= $scope.totalLength) {
                    $scope.stop();
                    return;
                };

                $scope.timeout = $timeout ( function() {
                    $scope.currentPosition = $scope.currentPosition + 1;
                    $scope.playForward();
                    $scope.$apply();
                }, 1000, null);
            }

            $scope.$watch('filename', function (newValue, oldValue) {
                if (newValue != oldValue) {
                    if ($scope.qtPlayer != null){
                        $scope.qtPlayer.Stop();
                        $scope.qtPlayer.Rewind();
                        $scope.qtPlayer = null;
                        $('#mediaPlayer').html($scope.createQtPlayerObject('audio/' + $scope.filename));
                    } else {
                        $('#mediaPlayer').html($scope.createQtPlayerObject('audio/' + $scope.filename));
                    }

                    $scope.qtPlayer = document.qtPlayer;

                    if ($scope.isPlaying) {
                        $scope.qtPlayer.Play();
                    }
                }
            });

            $scope.$watch('currentPosition', function (newValue, oldValue) {

                var cumLength = 0;
                angular.forEach($scope.recordings, function(value, key){

                    if ($scope.currentPosition >= cumLength &&
                            $scope.currentPosition < (cumLength + value.getLength()) )
                    {
                        $scope.segmentStart = cumLength;
                        $scope.filename = value.getName();
                    }
                    cumLength = cumLength + value.getLength();
                }, null);

                if ($scope.isBookmarkSet) {
                    if (newValue >= $scope.end){
                        $scope.stop()
                    }
                } else {
                    if (newValue >= $scope.totalLength){
                        $scope.stop()
                    }
                }

                if (!$scope.isBookmarkSet) {
                    $scope.slider.values($scope.start,$scope.currentPosition);
                }

                $scope.updatePositionLabel();

            }, true);

            $scope.updatePositionLabel = function (){
                if ($scope.isBookmarkSet) {
                    $scope.position = $scope.convertToTime($scope.start) + " (" + $scope.convertToTime($scope.currentPosition) + ") " + $scope.convertToTime($scope.end) + " / " + $scope.convertToTime($scope.totalLength);
                } else {
                    $scope.position = $scope.convertToTime($scope.start) + "-" + $scope.convertToTime($scope.currentPosition) + " / " + $scope.convertToTime($scope.totalLength);
                }
            }

            $scope.convertToTime = function (seconds) {

                var hr = Math.floor(seconds / 3600);
                var min = Math.floor((seconds - (hr * 3600))/60);
                var sec = seconds - (hr * 3600) - (min * 60);

                while (min.length < 2) {min = '0' + min;}
                while (sec.length < 2) {sec = '0' + min;}
                if (hr) hr += ':';
                return hr + min + ':' + sec;
            }

            $scope.createQtPlayerObject = function (url){
                var str = '<embed name="qtPlayer" width="0px" height="0px" AUTOPLAY="false" src="' + url + '" TYPE="video/quicktime" PLUGINSPAGE="www.apple.com/quicktime/download" enablejavascript="true">';
                str += '  </embed> ';
                return str;
            }
        }

        playerApp.directive('player', function (playerModel){
           return {
               restrict: 'E',
               replace: true,
               templateUrl: 'app/templates/directives/player.html',
               scope: {
                   //position: "="
               },
               controller: 'PlayerController'
           }
        });

        $(document).ready(function() {

            $("#definitions").kendoComboBox({
                dataTextField: "text",
                dataValueField: "value",
                dataSource: [
                    { text: "Def 1", value: "1" },
                    { text: "Def 2", value: "2" },
                    { text: "Def 3", value: "3" },
                    { text: "Def 4", value: "4" }
                ],
                filter: "contains",
                suggest: true,
                index: 0
            });

            $("#upload").kendoUpload({
                multiple: false,
                select: onSelect,
                localization : {select : "Select", dropFilesHere: "drop file here...", uploadSelectedFile: "DDDD"}
            });

            $('#findFile').bind("click", function(e){
                //$("#upload").open();
                $('#upload').trigger("click");
            });
            function onSelect(e) {
                $('#bookmarkFile').val(e.files[0].name);
            };


        });



    </script>
</body>
</html>